// ============================================================
//  Firestore Security Rules â€“ Food Donation App MVP
//  Deploy via: firebase deploy --only firestore:rules
// ============================================================

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // â”€â”€ Helper functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    /// Returns true when the caller is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    /// Returns true when the caller owns the given userId.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /// Fetches the caller's role from the `users` collection.
    function callerRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isDonor() { return isSignedIn() && callerRole() == 'donor'; }
    function isNGO()   { return isSignedIn() && callerRole() == 'ngo';   }
    function isAdmin() { return isSignedIn() && callerRole() == 'admin'; }

    // â”€â”€ /users/{userId} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  â€¢ Any authenticated user can read any user profile (needed for in-app
    //    display of donor/NGO names on donation cards).
    //  â€¢ Create is allowed during registration; update only by the owner.
    //  â€¢ Deletion is disallowed via rules (use Admin SDK in a Cloud Function).
    match /users/{userId} {
      allow read:   if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if false;
    }

    // â”€â”€ /donations/{donationId} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  â€¢ Any authenticated user can read listings (NGOs browse the map).
    //  â€¢ Only donors can CREATE a new donation.
    //  â€¢ A donor can UPDATE their own donation while it is still 'pending'
    //    (e.g. to edit details before it is claimed).
    //  â€¢ An NGO can UPDATE a donation to 'claimed' or 'completed'
    //    (for claim action & evidence upload).
    //  â€¢ Deletes are disallowed; listings are soft-deleted via a `status`
    //    field so historical records are preserved.
    match /donations/{donationId} {
      allow read: if isSignedIn();

      allow create: if isDonor()
                    && request.resource.data.donorId == request.auth.uid;

      allow update: if
        // ðŸŸ¢ Donor Actions:
        (isDonor() && resource.data.donorId == request.auth.uid && (
           // Full edit while pending OR transition to pickedUp (Confirm Handover)
           resource.data.status == 'pending' ||
           (resource.data.status == 'claimed' && request.resource.data.status == 'pickedUp')
        ))
        ||
        // ðŸŸ¢ NGO Actions:
        (isNGO() && (
           // 1. CLAIM: Transitions from pending to claimed.
           (resource.data.status == 'pending' && request.resource.data.status == 'claimed') ||
           
           // 2. CANCEL OWN CLAIM: Transitions back to pending if they are the current claimant.
           (resource.data.status == 'claimed' && 
            request.resource.data.status == 'pending' && 
            resource.data.ngoId == request.auth.uid) ||
            
           // 3. REVERT LATE CLAIM: Any NGO can revert a late listing to pending.
           (resource.data.status == 'claimed' &&
            request.resource.data.status == 'pending' &&
            resource.data.scheduledPickupTime < (request.time - duration.value(1, 'h'))) ||

           // 4. COMPLETE: Process evidence upload.
           (resource.data.status == 'pickedUp' && 
            request.resource.data.status == 'completed' && 
            resource.data.ngoId == request.auth.uid)
        ))
        ||
        // ðŸŸ¢ Admin override
        isAdmin();

      allow delete: if false;
    }

  } // end match /databases
}
